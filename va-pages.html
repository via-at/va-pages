<link rel="import" href="../neon-animation/neon-animation.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="./va-load/va-redirect-behavior.html">
<link rel="import" href="./va-load/va-load-behavior.html">

<dom-module id="va-pages">
  
  <template>
    
    <app-location route="{{route}}"></app-location>
    
    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{routeData}}"
      tail="{{subRoute}}"></app-route>
      
    <app-route
      route="{{subRoute}}"
      pattern="/:view"
      data="{{subRouteData}}"></app-route>
      
    <neon-animated-pages
      id="selector"
      entry-animation="[[entryAnimation]]"
      exit-animation="[[exitAnimation]]">
      
      <content></content>
    </neon-animated-pages>
      
  </template>
  
  <script>
    Polymer({
      
      is: 'va-pages',
      
      behaviors: [
        VA.PageLoadBehavior,
        VA.RedirectBehavior
      ],
      
      observers: [
        '_routeChanged(routeData.page)',
        '_subRouteChanged(subRouteData.view)'
      ],
      
      properties: {
        
        defaultPage: {
          type: String
        },
        
        forceRedirectOnce: {
          type: Boolean,
          value: false
        },
        
        restricted: {
          type: Boolean,
          observer: '_routeChanged'
        },
        
        restrictedPages: {
          type: Array
        },
        
        page: {
          notify: true,
          type: String
        },
        
        view: {
          notify: true,
          type: String
        }
      },
      
      _routeChanged: function() {
        var page;
        
        if (this.forceRedirectOnce) {
          this.forceRedirectOnce = false;
          page = this.defaultPage;
        } else {
          page = !this.routeData.page || this.routeData.page === '' ? this.defaultPage : this.routeData.page;
        }
        
        if (this.restricted) {
          if (this.restrictedPages.indexOf(page) !== -1) {
            this.replaceLocation('/');
            return;
          }
        }
        
        var children = Polymer.dom(this).children;
        var pageTagName = 'va-' + page;
        
        for (var i in children) {
          if (children[i].tagName.toLowerCase() === pageTagName) {
            this.$.selector.selectIndex(i);
            break;
          }
        }
      
        this.page = page;
      },
      
      _subRouteChanged: function (view) {
        this.view = view;
      }
      
    });
  </script>
  
</dom-module>
